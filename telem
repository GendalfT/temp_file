% --- Executes on button press in PPS1_checkbox.
function PPS1_checkbox_Callback(hObject, eventdata, handles)

if get(hObject, 'Value') == 1
    % PPS1 увімкнений
    stop(handles.telemetry_timer); % на всякий випадок зупиняємо таймер
    SendPacket(handles, handles.define.MB_COMMAND, 10); % команда 10 = PPS1 ON
else
    % PPS1 вимкнений
    SendPacket(handles, handles.define.MB_COMMAND, 7);  % команда 7 = PPS1 OFF
    
    % якщо телеметрія включена → запускаємо таймер
    if get(handles.checkbox_telemetry, 'Value') == 1
        start(handles.telemetry_timer);
    end
end
guidata(hObject, handles);

% --- Executes on button press in checkbox_telemetry.
function checkbox_telemetry_Callback(hObject, eventdata, handles)

if get(hObject, 'Value') == 1
    SendPacket(handles, handles.define.MB_COMMAND, 11); % вмикаємо телеметрію
    
    % якщо PPS1 вимкнений → запускаємо таймер
    if get(handles.PPS1_checkbox, 'Value') == 0
        start(handles.telemetry_timer);
    end
else
    % телеметрія вимкнена → зупиняємо таймер
    stop(handles.telemetry_timer);
end
guidata(hObject, handles);

% --- Function for telemetry timer
function timerWrapper(hObject)
handles = guidata(hObject);
SendPacket(handles, handles.define.MB_COMMAND, 7); % команда 7 = PPS1 OFF (запит телеметрії)




function yourgui_OpeningFcn(hObject, eventdata, handles, varargin)
    handles.output = hObject;

    % (за потреби) створюємо таймер, якщо він ще не створений
    if ~isfield(handles, 'telemetry_timer') || ~isvalid(handles.telemetry_timer)
        handles.telemetry_timer = timer( ...
            'ExecutionMode','fixedRate', ...
            'Period',1, ...
            'TimerFcn', @(~,~) timerWrapper(hObject));
    end

    % 1) візуально позначити чекбокс PPS1
    set(handles.PPS1_checkbox, 'Value', 1);

    % 2) застосувати побічні дії так само, як при ручному кліку
    PPS1_checkbox_Callback(handles.PPS1_checkbox, [], handles);

    guidata(hObject, handles);
end




% --- Executes on button press in PPS1_checkbox.
function PPS1_checkbox_Callback(hObject, eventdata, handles)
isPPS1 = get(handles.PPS1_checkbox, 'Value');   % 1 = ON, 0 = OFF
isTel  = get(handles.checkbox_telemetry, 'Value');

if isPPS1
    % PPS1 ON -> таймер повинен бути зупинений
    if isfield(handles,'telemetry_timer') && isvalid(handles.telemetry_timer) ...
            && strcmp(get(handles.telemetry_timer,'Running'),'on')
        stop(handles.telemetry_timer);
    end
    SendPacket(handles, handles.define.MB_COMMAND, 10); % PPS1 ON
else
    % PPS1 OFF -> якщо телеметрія увімкнена, запускаємо таймер
    SendPacket(handles, handles.define.MB_COMMAND, 7);  % PPS1 OFF
    if isTel && isfield(handles,'telemetry_timer') && isvalid(handles.telemetry_timer) ...
            && strcmp(get(handles.telemetry_timer,'Running'),'off')
        start(handles.telemetry_timer);
    end
end
guidata(hObject, handles);


% --- Executes on button press in checkbox_telemetry.
function checkbox_telemetry_Callback(hObject, eventdata, handles)
isTel  = get(handles.checkbox_telemetry, 'Value'); % 1 = ON
isPPS1 = get(handles.PPS1_checkbox, 'Value');      % 1 = ON

if isTel
    SendPacket(handles, handles.define.MB_COMMAND, 11); % telemetry ON
    % Запускаємо таймер тільки якщо PPS1 вимкнений
    if ~isPPS1 && isfield(handles,'telemetry_timer') && isvalid(handles.telemetry_timer) ...
            && strcmp(get(handles.telemetry_timer,'Running'),'off')
        start(handles.telemetry_timer);
    end
else
    % Телеметрія OFF -> зупиняємо таймер
    if isfield(handles,'telemetry_timer') && isvalid(handles.telemetry_timer) ...
            && strcmp(get(handles.telemetry_timer,'Running'),'on')
        stop(handles.telemetry_timer);
    end
end
guidata(hObject, handles);
